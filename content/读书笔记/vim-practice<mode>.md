---
title: "Vim 模式"
layout: page
date: 2020-05-02 15:02
collection: "Vim 实用技巧"
tag: vim
---
[TOC]

# 普通模式 #

## 技巧 7 停顿时请移开画笔 ##

就像画家只花一小部分时间涂色一样，程序员也只花一小部分时间编写代码。绝大多数时间用来思考、阅读，以及在代码中穿梭浏览。而且，当确实需要做修改时，谁说一定要切换到插入模式才行？我们可以重新调整已有代码的格式，复制它们，移动其位置，或是删除它们。在普通模式中，我们有众多的工具可以利用。

## 技巧 8 把撤销单元切成块 ##

`u` 键会触发撤销命令，它会撤销最新的修改。**一次修改可以是改变文档内文本的任意操作**，其中包括在普通模式、可视模式以及命令行模式中所触发的命令，而且一次修改也包括了在插入模式中输入（或删除）的文本，因此我们也可以说，`i{insert some text}<Esc>` 是一次修改。

在 Vim 中，我们自己可以控制撤销命令的粒度。从进入插入模式开始，直到返回普通模式为止，在此期间输入或删除的任何内容都被当成一次修改。因此，只要我们控制好对 `<Esc>` 键的使用，就可使撤销命令作用于单词、句子或段落。

当处于插入模式时，如果光标位于行尾的话，另起一行最快的方式是按 `<CR>`。不过有时我更喜欢按 `<Esc>o`，这是因为我有预感，也许在撤销时我想拥有更细的粒度。

> **NOTE 在插入模式中移动光标会重置修改状态**
> 
> 如果在插入模式中使用了 `<Up>` 、`<Down>` 、`<Left>` 或 `<Right>` 这些光标键，将会产生一个新的撤销块。你可以把这想象为先切换回普通模式，然后用 `h`、`j`、`k` 或 `l` 命令对光标进行了移动，唯一区别是我们并没有退出插入模式。这也会对 `.` 命令的操作产生影响。

### 技巧 9 构造可重复的修改 ###

Vim对重复操作进行了优化，要利用这一点，我们必须考虑该如何构造修改。

在 Vim 中，要完成一件事，总是有不止一种方式。在评估哪种方式最好时，最显而易见的指标是效率，即哪种手段需要的按键次数最少（又名 [VimGolf](http://vimgolf.com)）。

### 示例 ###

在下例中，假设光标位于行尾处的字符“h”上，而我们想要删除单词“nigh”。

1. 反向删除
    
    ![17539bebe90671215f28693684ddfebc.png](/wiki/images/reading-notes/vim-practice/album_temp_1588336413.PNG)
    
    按 `db` 命令删除从光标起始位置到单词开头的内容，但会原封未动地留下最后一个字符 “h”，再按一下 `x` 键就可以删除这个捣乱的字符。这样，整个操作的 VimGolf 得分是 *3* 分。
    
    如果我们跟着执行一次 `.` 命令，它会重复删除一个字符（`.` == `x`）。我不觉得这有什么价值。
    
2. 正向删除

    ![752772ee75953c094fcb8b90961bb278.png](/wiki/images/reading-notes/vim-practice/album_temp_1588336417.PNG)
    
    我们先用 `b` 命令把光标移到单词的开头，移动好后，就可以用一个 `dw` 命令删掉整个单词。这一次的 VimGolf 得分也是 *3* 分。
    
    此时用 `.` 命令会重复 `dw`，删除从光标位置到下个单词开头的内容。不过因为我们刚好已经在行尾了，并没有“下一个单词”，所以在这个场景里 `.` 命令没什么用。不过，至少它代表了一个更长点的操作（`.` == `dw`）。
    
3. 删除整个单词
    
    我们也可以使用更为精准的 `aw` **文本对象（text object）**，而不是用动作命令。
    
    ![c77ca689bd5ebf02bcdb647f5daa1375.png](/wiki/images/reading-notes/vim-practice/album_temp_1588336423.PNG)
    
    你可以把 `daw` 命令解读为“delete a word”，这样比较容易记忆。
    
    如果此时我们使用 `.` 命令，它会重复上次删除单词的命令。这一次，`.` 命令会做真正有用的事情（`.` == `daw`）。
    
`daw` 可以发挥 `.` 命令的最大威力，因此我宣布它是本轮的获胜者。
    
### 技巧 10 用次数做简单的算术运算 ###

很多普通模式命令都可以带一个次数前缀，这样 Vim 就会尝试把该命令执行指定的次数，而不是只执行一次。

`<C-a>` 和 `<C-x>` 命令分别对数字执行加和减操作。在不带次数执行时，它们会逐个加减，但如果带一个次数前缀，那么就可以用它们加减任意整数。例如，如果我们把光标移到字符 5 上，执行 `10<C-a>` 就会把它变成 15。

文档里说，`<C-a>` 命令会“把当前光标之上或之后的数值加上[count]”。因此，如果光标不在数字上，那么 `<C-a>` 命令将在当前行正向查找一个数字，如果找到了，它就径直跳到那里。

#### 示例 ####

我们要对下面的 CSS 代码做一些改动：复制最后一行，用 “news” 替换单词 “blog”，以及把 “0px” 改为 “-180px”。

```css
.blog, .news { background-image: url(/sprite.png); }
.blog { background-position: 0px 0px }
```

![53a76a1144db38619075adc74acb8672.png](/wiki/images/reading-notes/vim-practice/album_temp_1588342315.PNG)

> **NOTE 数字的格式**
> 
> Vim 把以 `0` 开头的数字解释为八进制值，而不是十进制。
> 如果想让 Vim 把所有数字都当成十进制，不管它们是不是以 `0` 开头的，使用下面的命令
> 
> `set nrformats=`

### 技巧 11 能够重复，就别用次数 ###

如果想要删除两个单词，可以有几种方法：

1. `d2w`：我们先调用删除命令，然后以 `2w` 作为动作命令，我们可以把它解读为“删除两个单词”；
2. `2dw`：次数作用于删除命令，而动作命令只跨越一个单词，我们可以把这解读为“做两次删除单词的操作”；
3. `dw.`：可以解读为“删除一个单词，然后重复上次的操作”。

`d2w` 和 `2dw` 是相同的，在执行完两者中的任一个后，我们可以按 `u` 键撤销。或者，我们不是用撤销，而是用 `.` 命令重复执行它，这就会删除后面的两个单词。

对于 `dw.` 的情形，按 `u` 或 `.` 的结果会有细微的差别。这里的修改是 `dw`，即删除一个单词。因此，如果想恢复这两个被删除的单词，必须撤销两次，按 `uu`（或者 `2u`）。按 `.` 则只删除后面的一个单词，而不是两个。

现在假设我们原本是想删除 3 个单词，而不是 2 个。由于判断出了点差错，我们执行了 `d2w` 而不是 `d3w`。我们不能使用 `.` 命令，因为那会总共删除 4 个单词。因此，我们或是先撤销而后修正次数（`ud3w`），或是继续删除下一个单词（`dw`）。现在考虑另一种方案，如果我们在第一处地方用的是 `dw.` 命令，那么我们只要再多重复一次 `.` 命令就行了。因为我们最初的修改只是简单的 `dw`，因此 `u` 命令和 `.` 命令都具有更细的粒度，每次只作用于一个单词。

计算次数很是讨厌，因此我宁愿按多次 `.` 命令，也不愿意只为减少按键的次数，而浪费同样的时间去统计次数。如果我多按了一次 `.` 命令怎么办？没关系，只要按一次 `u` 键就可以回退回来。

> **NOTE 只在必要时使用次数**
> 
> 假设我们想把文字 “I have a couple of questions” 改为 “I have some more questions”，可以用下面的方式做：
> 
> ![abdd41f7efbee56fb5086d5075aa63c9.png](/wiki/images/vim-practice/album_temp_1588343073.PNG)
> 
> 在此场景中，使用 `.` 命令的意义不大，我们可以删除一个单词，然后再用 `.` 命令删除另一个，但随后我们还得切换到插入模式。对我来说这么做很不顺手，我反而更愿意用次数。
> 
> 使用次数的另一个好处是：它**保留了一个干净、连贯的撤销历史记录**。完成这次修改后，我们按一下 `u` 键就可以撤销整个修改。

### 技巧 12 双剑合璧，天下无敌 ###

Vim 的强大很大程度上源自操作符与动作命令相结合。

```
操作符 + 动作命令 = 操作
```

`d{motion}` 命令可以对一个字符（`dl`）、一个完整单词（`daw`）或一整个段落（`dap`）进行操作，它作用的范围由动作命令决定。`c{motion}`、`y{motion}` 以及其他一些命令也类似，它们被统称为 **操作符（operator）**。

常见操作符

| 命令 | 用途 |
| --- | --- |
| `c` | 修改 |
| `d` | 删除 |
| `y` | 复制到寄存器 |
| `g~` | 反转大小写 |
| `gu` | 转换为小写 |
| `gU` | 转换为大写 |
| `>` | 增加缩进 |
| `<` | 减小缩进 |
| `=` | 自动缩进 |
| `!` | 使用外部程序过滤 `{motion}` 所跨越的行 |

操作符与动作命令的结合形成了一种语法。这种语法的第一条规则很简单，即一个操作由一个操作符，后面跟一个动作命令组成。

Vim 的语法只有一条额外规则，即当一个操作符命令被连续调用两次时，它会作用于当前行。所以 `dd` 删除当前行，而 `>>` 缩进当前行。`gU` 命令是一种特殊情况，我们既可以用 `gUgU` ，也可以用简化版的 `gUU` 来使它作用于当前行。

#### 扩展命令组合的威力 ####

使用 Vim 缺省的操作符和动作命令，我们能够执行的操作的数目是巨大的，然而，我们还可以通过自定义动作命令及操作符来进一步扩充其数目。

##### 自定义操作符与已有动作命令协同工作 #####

随同 Vim 发布的标准操作符集合相对比较少，但我们可以定义新的操作符。TimPope 的 [commentary.vim](https:/github.com/tpope/vim-commentary) 插件提供了一个很好的例子，此插件为 Vim 所支持的编程语言增添了注释及取消注释的命令。

注释命令以 `\\{motion}` 触发，它会切换指定行的注释状态。它是一个操作符命令，因此可以把它和所有动作命令结合在一起。`\\ap` 将切换当前段落的注释状态，`\\G` 会把从当前行到文件结尾间的所有内容注释掉，而 `\\\` 则注释当前行。如果你对如何创建自定义操作符感到好奇，可以先阅读一下文档 `:h:map-operator`。`

##### 自定义动作命令与已有操作符协同工作 #####

Kana Natsuno 的 [textobj-entire](https://github.com/kana/vim-textobj-entire) 插件是一个很好的例子，它为 Vim 增加了两种新的文本对象 `ie` 和 `ae`，它们作用于整个文件。

如果想用 `=` 命令自动缩进整个文件，我们可以执行 `gg=G` （就是说，先用 `gg` 跳到文件开头，然后用 `=G` 自动缩进从光标位置到文件结尾的所有内容）。但是如果我们安装了 textobj-entire 插件的话，简单地执行 `=ae` 就可以了。运行这条命令时光标在哪儿并不重要，因为它总是作用于整个文件。

> **NOTE**
> 
> 如果我们同时安装了 commentary 和 textobj-entire 插件，就可以把它们放在一起使用。例如，执行 `\\ae` 会切换整个文件的注释状态。

如果你对如何创建自定义动作命令感到好奇，可以由阅读 `:h omap-info` 开始。

##### 结识操作符待决模式 #####

Vim 还有另外一些很容易被忽视的模式，**操作符待决模式（Operator-Pending mode）**。

在我们执行命令 `dw` 时，就会激活该模式。这一模式只在按 `d` 及 `w` 键之间的短暂时间间隔内存在，一眨眼工夫就不见了。

如果我们把 Vim 想象成有限状态机，那么操作符待决模式就是一个只接受动作命令的状态。这个状态在我们调用操作符时被激活，然后什么也不做，直到我们提供了一个动作命令，完成整个操作。当操作符待决模式被激活时，我们可以像平常一样按 `<Esc>` 中止该操作，返回到普通模式。

很多命令都由两个或更多的按键来调用，但在多数情况下，头一个按键只是第二个按键的前缀。这些命令不会激活操作符待决模式，相反，可以把它们当成 **命名空间（namespace）**，用来扩充可用命令的数目。只有操作符才会激活操作符待决模式。

为什么要有一个完整的模式，专门用于操作符和动作命令之间的短暂瞬间，而命名空间命令则仅仅是普通模式的一个扩充？这是因为我们能够创建自定义映射项来激活或终结操作符待决模式。换句话说，**它允许我们创建自定义的操作符及动作命令，从而让我们可以扩充 Vim 的词汇。**

